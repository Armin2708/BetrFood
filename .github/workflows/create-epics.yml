name: Create BetrFood Project Board

on:
  push:
    branches:
      - claude/create-app-epics-ZcWv6
    paths:
      - '.github/workflows/create-epics.yml'
  workflow_dispatch:

permissions:
  issues: write
  repository-projects: write
  contents: read

jobs:
  create-project:
    runs-on: ubuntu-latest
    steps:
      - name: Create Project Board & Add Epic Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Step 1: Get all epic-labeled issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'epic',
              state: 'open',
              per_page: 20
            });
            console.log(`Found ${issues.data.length} epic issues`);

            if (issues.data.length === 0) {
              console.log('No epic issues found. Skipping project creation.');
              return;
            }

            // Step 2: Check if project already exists
            const existingProjects = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            let project;
            const existing = existingProjects.data.find(p => p.name === 'BetrFood Development');

            if (existing) {
              console.log(`Project already exists: ${existing.name} (ID: ${existing.id})`);
              project = existing;
            } else {
              // Create a new classic project board
              const created = await github.rest.projects.createForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'BetrFood Development',
                body: 'Main development board for BetrFood iOS app â€” tracking all epics and features across 6 core areas: Content, Users, Pantry, AI Chat, Discovery, and Settings.'
              });
              project = created.data;
              console.log(`Created project: ${project.name} (ID: ${project.id})`);
            }

            // Step 3: Create columns (if they don't exist)
            const existingColumns = await github.rest.projects.listColumns({
              project_id: project.id
            });
            const existingColNames = existingColumns.data.map(c => c.name);

            const columnNames = ['Backlog', 'In Progress', 'Review', 'Done'];
            const columnIds = {};

            // Map existing columns
            for (const col of existingColumns.data) {
              columnIds[col.name] = col.id;
            }

            // Create missing columns
            for (const colName of columnNames) {
              if (!existingColNames.includes(colName)) {
                const col = await github.rest.projects.createColumn({
                  project_id: project.id,
                  name: colName
                });
                columnIds[colName] = col.data.id;
                console.log(`Created column: ${colName}`);
              } else {
                console.log(`Column already exists: ${colName}`);
              }
            }

            // Step 4: Add epic issues to Backlog column
            const backlogId = columnIds['Backlog'];

            // Get existing cards to avoid duplicates
            const existingCards = await github.rest.projects.listCards({
              column_id: backlogId,
              per_page: 100
            });
            const existingContentIds = existingCards.data
              .filter(c => c.content_url)
              .map(c => c.content_url);

            for (const issue of issues.data) {
              const issueApiUrl = issue.url;
              if (existingContentIds.includes(issueApiUrl)) {
                console.log(`Issue #${issue.number} already in Backlog, skipping`);
                continue;
              }

              try {
                await github.rest.projects.createCard({
                  column_id: backlogId,
                  content_id: issue.id,
                  content_type: 'Issue'
                });
                console.log(`Added issue #${issue.number} to Backlog: ${issue.title}`);
              } catch (e) {
                console.log(`Failed to add issue #${issue.number}: ${e.message}`);
              }
            }

            console.log('\n=== Setup Complete ===');
            console.log(`Project URL: ${project.html_url}`);
            console.log(`Epic issues: ${issues.data.map(i => '#' + i.number).join(', ')}`);
