name: Create BetrFood Project Board

on:
  push:
    branches:
      - claude/create-app-epics-ZcWv6
    paths:
      - '.github/workflows/create-epics.yml'
  workflow_dispatch:

permissions:
  issues: write
  repository-projects: write
  contents: read

jobs:
  create-project:
    runs-on: ubuntu-latest
    steps:
      - name: Create Project Board & Add Epic Issues
        uses: actions/github-script@v7
        with:
          script: |
            // Step 1: Get all epic-labeled issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'epic',
              state: 'open',
              per_page: 20
            });
            console.log(`Found ${issues.data.length} epic issues`);
            issues.data.forEach(i => console.log(`  #${i.number}: ${i.title}`));

            if (issues.data.length === 0) {
              console.log('No epic issues found. Skipping.');
              return;
            }

            // Step 2: Create classic project board
            let project;
            try {
              // Check if project exists
              const existing = await github.rest.projects.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              project = existing.data.find(p => p.name === 'BetrFood Development');

              if (project) {
                console.log(`Project already exists: ${project.name} (ID: ${project.id})`);
              }
            } catch (e) {
              console.log(`Warning listing projects: ${e.status} ${e.message}`);
            }

            if (!project) {
              try {
                const created = await github.rest.projects.createForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'BetrFood Development',
                  body: 'Main development board for BetrFood iOS app'
                });
                project = created.data;
                console.log(`Created project: ${project.name} (ID: ${project.id})`);
              } catch (e) {
                core.error(`Failed to create project: HTTP ${e.status} - ${e.message}`);
                core.setFailed(`Cannot create project: ${e.message}. You may need to enable Projects in repo Settings > Features > Projects.`);
                return;
              }
            }

            // Step 3: Create columns
            const columnNames = ['Backlog', 'In Progress', 'Review', 'Done'];
            const columnIds = {};

            try {
              const existingCols = await github.rest.projects.listColumns({ project_id: project.id });
              existingCols.data.forEach(c => { columnIds[c.name] = c.id; });
            } catch (e) {
              console.log(`Warning listing columns: ${e.message}`);
            }

            for (const name of columnNames) {
              if (!columnIds[name]) {
                try {
                  const col = await github.rest.projects.createColumn({ project_id: project.id, name });
                  columnIds[name] = col.data.id;
                  console.log(`Created column: ${name}`);
                } catch (e) {
                  console.log(`Warning creating column ${name}: ${e.message}`);
                }
              } else {
                console.log(`Column exists: ${name}`);
              }
            }

            // Step 4: Add issues to Backlog
            const backlogId = columnIds['Backlog'];
            if (!backlogId) {
              core.setFailed('Backlog column not found');
              return;
            }

            for (const issue of issues.data) {
              try {
                await github.rest.projects.createCard({
                  column_id: backlogId,
                  content_id: issue.id,
                  content_type: 'Issue'
                });
                console.log(`Added #${issue.number} to Backlog`);
              } catch (e) {
                if (e.status === 422) {
                  console.log(`#${issue.number} already in project`);
                } else {
                  console.log(`Warning adding #${issue.number}: ${e.status} ${e.message}`);
                }
              }
            }

            console.log(`\nDone! Project: ${project.html_url}`);
